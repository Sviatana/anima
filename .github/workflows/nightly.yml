name: Nightly sanity & ping

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    env:
      PROJECT_URL: "https://web-production-b9ae.up.railway.app"   # ‚Üê –∑–∞–º–µ–Ω–∏ <project>
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: "<743050845>"            # ‚Üê —Ç–≤–æ–π ID
      REPORTS_TOKEN: ${{ secrets.REPORTS_TOKEN }}
    steps:
      - name: Check health
        id: health
        run: |
          set -e
          code=$(curl -s -o /dev/null -w "%{http_code}" "$PROJECT_URL/healthz")
          echo "code=$code" >> $GITHUB_OUTPUT

      - name: Send OK
        if: steps.health.outputs.code == '200'
        run: |
          msg="‚úÖ Nightly: $PROJECT_URL –∂–∏–≤ (200)."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${msg}\"}" > /dev/null

      - name: Send ALERT
        if: steps.health.outputs.code != '200'
        run: |
          msg="‚ùå Nightly: $PROJECT_URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (code=${{ steps.health.outputs.code }})."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${msg}\"}" > /dev/null

      - name: Optional summary
        if: env.REPORTS_TOKEN != ''
        run: |
          curl -s -H "x-token: ${REPORTS_TOKEN}" "$PROJECT_URL/reports/summary" \
            | jq -r '["üìä Nightly KPI", "avg_quality_30d: \(.kpi.avg_quality_30d // "n/a")", "safety_rate_30d: \(.kpi.safety_rate_30d // "n/a")", "answers_30d: \(.kpi.answers_30d // "n/a")"] | join("\n")' \
            | xargs -0 -I {} bash -c \
              'curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -H "Content-Type: application/json" \
               -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":\"{}\"}" > /dev/null' || true
